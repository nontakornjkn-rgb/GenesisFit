<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aegis-Fit SAINT Console Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: "Inter", sans-serif;
      background: #0d1117;
      color: #e5e7eb;
    }
    .console-bg {
      background-color: #161b22;
      box-shadow: 0 0 15px rgba(0, 198, 255, 0.4 );
      border: 1px solid #00c6ff30;
    }
    .metric-card {
      background-color: #0d1117;
      border-left: 4px solid #00c6ff;
      transition: all 0.3s;
    }
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 198, 255, 0.2);
    }
    .aether-text {
      color: #00c6ff;
      text-shadow: 0 0 5px #00c6ff80;
    }
  </style>
</head>
<body class="p-6">
  <div class="console-bg p-6 rounded-lg">
    <h1 class="text-2xl font-bold aether-text mb-4">
      SAINT Console Dashboard
    </h1>

    <!-- User Info -->
    <div class="metric-card p-4 mb-4">
      <p><strong>SAINT ID:</strong> <span id="saint-id-display">N/A</span></p>
      <p><strong>Level:</strong> <span id="current-level">0</span></p>
      <p><strong>Aether Load:</strong> <span id="aether-load-value">0%</span></p>
    </div>

    <!-- Biometrics -->
    <div class="metric-card p-4 mb-4">
      <div class="mb-2">
        <strong>BMI:</strong>
        <span id="current-bmi">N/A</span>
      </div>

      <div class="flex flex-wrap items-center gap-3">
        <label class="flex items-center gap-2">
          <span>Weight (kg):</span>
          <input
            id="current-weight"
            type="number"
            class="p-1 bg-gray-800 text-white rounded w-24"
          />
        </label>

        <label class="flex items-center gap-2">
          <span>Height (cm):</span>
          <input
            id="current-height"
            type="number"
            class="p-1 bg-gray-800 text-white rounded w-24"
          />
        </label>

        <!-- FIX: Changed to id="updateButton" -->
        <button
          id="updateButton" 
          class="px-4 py-1 bg-green-600 text-white rounded"
        >
          Update
        </button>
      </div>
    </div>

    <!-- Protocols -->
    <div class="metric-card p-4 mb-4">
      <h2 class="font-semibold mb-2">Training Protocols</h2>
      <div id="protocol-container"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      signInAnonymously,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      onSnapshot,
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyB7kVrfqasbqqtu70JD5_MXr5HjLw0ChAY",
      authDomain: "genesisfit-cc8db.firebaseapp.com",
      projectId: "genesisfit-cc8db",
      storageBucket: "genesisfit-cc8db.appspot.com",
      messagingSenderId: "1077638647212",
      appId: "1:1077638647212:web:dd6b3bfcb4705266e03e09",
    };

    const app = initializeApp(firebaseConfig );
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUserId = null;

    // --- MOCK DATA (for initial setup) ---
    const MOCK_USER_DATA = {
      currentLevel: 3,
      aetherLoad: 65,
      weightKg: 89, // Example weight
      heightCm: 182, // Example height
    };

    const MOCK_PROTOCOL_DATA = [
      { name: "Ares Pulse", rank: "S-Tier", description: "High-intensity metabolic conditioning.", target: "Cardio" },
      { name: "Atlas Core", rank: "A-Tier", description: "Maximal stabilization and trunk strength.", target: "Core" },
      { name: "Hermes Sprint", rank: "B-Tier", description: "Explosive lower body power training.", target: "Legs" },
      { name: "Apollo Focus", rank: "A-Tier", description: "Precision movements and muscle control.", target: "Flexibility" },
    ];
    // --- END MOCK DATA ---

    const setupAuth = async () => {
      try {
        await signInAnonymously(auth);
      } catch (err) {
        console.error("Anonymous Sign-In Failed:", err);
      }
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUserId = user.uid;
        document.getElementById("saint-id-display").textContent = currentUserId.substring(0, 8) + '...';
        initDashboard(currentUserId);
      } else {
        console.log("User is signed out.");
      }
    });

    const initDashboard = async (userId) => {
      if (!userId) return;
      
      // Load mock data for display
      fetchUserData(userId); 
      fetchProtocolData();

      // Listen for real-time updates from Firestore
      const userDocRef = doc(db, `artifacts/genesisfit/users/${userId}/biometrics/latest`);
      onSnapshot(userDocRef, (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          document.getElementById("current-bmi").textContent = data.bmi || "N/A";
          document.getElementById("current-weight").value = data.weightKg ?? "";
          document.getElementById("current-height").value = data.heightCm ?? "";
        } else {
          // If no data in Firestore, use mock data to populate fields
          console.log("No biometrics data in Firestore, using initial mock data.");
          const initialBmi = calculateBmi(MOCK_USER_DATA.weightKg, MOCK_USER_DATA.heightCm);
          updateBiometricsInFirestore(userId, MOCK_USER_DATA.weightKg, MOCK_USER_DATA.heightCm, initialBmi);
        }
      });
    };

    const fetchUserData = (userId) => {
      const data = { ...MOCK_USER_DATA, saintId: userId };
      document.getElementById("current-level").textContent = data.currentLevel;
      document.getElementById("aether-load-value").textContent = data.aetherLoad + "%";
      document.getElementById("current-weight").value = data.weightKg;
      document.getElementById("current-height").value = data.heightCm;
      document.getElementById("current-bmi").textContent = calculateBmi(data.weightKg, data.heightCm);
    };

    const fetchProtocolData = () => {
      const protocolContainer = document.getElementById("protocol-container");
      protocolContainer.innerHTML = "";
      MOCK_PROTOCOL_DATA.forEach((protocol) => {
        const item = document.createElement("div");
        item.className = "p-3 bg-gray-800 rounded-lg flex justify-between items-center hover:bg-gray-700 transition";
        item.innerHTML = `
          <div>
            <p class="font-bold text-cyan-400">${protocol.name} <span class="text-sm text-gray-400">(${protocol.rank})</span></p>
            <p class="text-sm text-gray-500">${protocol.description}</p>
          </div>
          <span class="text-xs px-2 py-1 rounded-full bg-cyan-600 text-white">${protocol.target}</span>
        `;
        protocolContainer.appendChild(item);
      });
    };

    const calculateBmi = (weight, height) => {
      if (!weight || !height || height <= 0) return "N/A";
      const heightInMeters = height / 100;
      return (weight / (heightInMeters * heightInMeters)).toFixed(1);
    };

    const updateBiometricsInFirestore = async (userId, weight, height, bmi) => {
        if (!userId) return;
        const userDocRef = doc(db, `artifacts/genesisfit/users/${userId}/biometrics/latest`);
        try {
            await setDoc(userDocRef, {
                weightKg: weight,
                heightCm: height,
                bmi: bmi,
                lastSynced: new Date().toISOString(),
            }, { merge: true });
            console.log("Biometrics updated in Firestore.");
        } catch (error) {
            console.error("Error updating Firestore:", error);
        }
    };

    // This function will be called when the button is clicked
    const handleUpdateClick = () => {
      const weight = parseFloat(document.getElementById("current-weight").value);
      const height = parseFloat(document.getElementById("current-height").value);
      
      const bmi = calculateBmi(weight, height);
      document.getElementById("current-bmi").textContent = bmi;

      // Update the data in Firestore
      updateBiometricsInFirestore(currentUserId, weight, height, bmi);
    };

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        setupAuth();
        // FIX: Correctly finds the button and adds the event listener
        const updateButton = document.getElementById('updateButton');
        if (updateButton) {
            updateButton.addEventListener('click', handleUpdateClick);
        } else {
            console.error("Update button not found!");
        }
    });
  </script>
</body>
</html>
